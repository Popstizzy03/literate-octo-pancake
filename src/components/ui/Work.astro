---
import { getCollection } from 'astro:content';

// Fetch featured projects from the Content Collection
const allProjects = await getCollection('projects');
const featuredProjects = allProjects
  .filter(project => project.data.featured)
  .sort((a, b) => a.data.sortOrder - b.data.sortOrder);
---

<!-- WORK SECTION -->
<section id="work" class="mb-32">
  <div class="flex items-end justify-between mb-12 border-b border-[var(--color-border)] pb-4">
    <h2 class="text-4xl font-bold">Featured Sessions</h2>
    <a href="/work" class="hidden md:inline-block text-[var(--color-signal)] hover:text-white transition-colors">View All Archive -></a>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {featuredProjects.map((project) => (
      <article class="group cursor-pointer" data-jingle={project.data.jingle}>
        <!-- The 'glass-panel' utility creates that deep, glossy look -->
        <div 
          class="glass-panel h-64 rounded-sm mb-4 relative overflow-hidden transition-transform duration-500 group-hover:-translate-y-1"
          style={project.data.coverImage ? `background-image: url(${project.data.coverImage}); background-size: cover; background-position: center;` : ''}
        >
          <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/80"></div>
          
          <!-- Play Button Overlay -->
          {project.data.jingle && (
            <div class="absolute inset-0 flex items-center justify-center"> {/* Removed opacity-0 group-hover:opacity-100 */}
              <button class="play-button w-16 h-16 rounded-full bg-[var(--color-signal)] text-black flex items-center justify-center shadow-[0_0_30px_rgba(202,138,4,0.4)]">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="play-icon w-8 h-8 ml-1">
                    <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                  </svg>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="pause-icon w-8 h-8 hidden">
                    <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 01.75.75v12a.75.75 0 01-1.5 0v-12a.75.75 0 01.75-.75zM16.5 5.25a.75.75 0 01.75.75v12a.75.75 0 01-1.5 0v-12a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                  </svg>
              </button>
            </div>
          )}
        </div>

        <div>
           <span class="font-mono text-xs text-[var(--color-signal)] uppercase tracking-wider">{project.data.category}</span>
           <h3 class="text-xl font-bold text-[var(--color-ink-primary)] mt-1 group-hover:text-[var(--color-signal)] transition-colors">{project.data.title}</h3>
           <p class="text-sm text-[var(--color-ink-secondary)] mt-2 line-clamp-2">{project.data.description}</p>
        </div>
      </article>
    ))}
  </div>
</section>

<script>
  import { audioPlayer } from '/src/store.ts';

  document.addEventListener('DOMContentLoaded', () => {
    const playButtons = document.querySelectorAll('.play-button');

    // Initial setup and subscribe to store changes
    audioPlayer.subscribe(state => {
      playButtons.forEach(button => {
        const article = button.closest('article[data-jingle]');
        const jingle = article ? article.dataset.jingle : null;
        const playIcon = button.querySelector('.play-icon');
        const pauseIcon = button.querySelector('.pause-icon');

        if (state.currentTrack === jingle && state.isPlaying) {
          playIcon.classList.add('hidden');
          pauseIcon.classList.remove('hidden');
        } else {
          playIcon.classList.remove('hidden');
          pauseIcon.classList.add('hidden');
        }
      });
    });

    // Attach click listeners
    playButtons.forEach(button => {
      button.addEventListener('click', (event) => {
        event.stopPropagation();
        const article = button.closest('article[data-jingle]');
        if (article) {
          const jingle = article.dataset.jingle;
          if (jingle) {
            audioPlayer.setTrack(jingle);
          }
        }
      });
    });
  });
</script>